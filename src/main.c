/**
 * Author: Jakub Lůčný (xlucnyj00)
 * Date: 10.12.2025
 * 
 * VUT FIT IMP 2025
 */

#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <stdbool.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "esp_log.h"
#include "esp_event.h"
#include "esp_system.h"
#include "u8g2.h"
#include "esp_wifi.h"
#include "esp_netif.h"
#include "nvs_flash.h"

#include "i2c_bus.h"
#include "display.h"
#include "wifi.h"
#include "portal.h"
#include "sensor.h"
#include "mqtt.h"

#define TAG "Meteostation"

#define DISPLAY_ADDR CONFIG_I2C_DISPLAY_ADDRESS

#ifndef CONFIG_AP_SSID
#define CONFIG_AP_SSID "ESP_Config"
#endif

#define WIFI_CONNECT_TIMEOUT_MS 10000

#ifndef CONFIG_MQTT_BROKER_URI
#define CONFIG_MQTT_BROKER_URI "mqtt://broker.hivemq.com:1883"
#endif
#ifndef CONFIG_MQTT_TOPIC
#define CONFIG_MQTT_TOPIC "meteostanice/measurements"
#endif

/****************************************************************************
    Main application entry point
****************************************************************************/
void app_main(void) {
    // Reset credentials stored in NVS (uncomment for testing purposes only)
    // ESP_LOGD(TAG, "TESTING: Erasing NVS!");
    // ESP_ERROR_CHECK(nvs_flash_erase());

    nvs_init();
    wifi_sta_init();
    i2c_bus_init();

    u8g2_t u8g2;
    display_init(&u8g2, DISPLAY_ADDR);

    // Try to load stored credentials from NVS
    char ssid[64] = {0}, pass[64] = {0};
    bool have_nvs = wifi_load_creds(ssid, sizeof(ssid), pass, sizeof(pass));
    if (!have_nvs) {
        // No credentials found; start config portal
        portal_run_blocking(&u8g2);
    }
    else {
        // Found credentials, try to connect; if fails, open config portal
        wifi_config_t sta = {0};
        strncpy((char*)sta.sta.ssid, ssid, sizeof(sta.sta.ssid));
        strncpy((char*)sta.sta.password, pass, sizeof(sta.sta.password));

        esp_wifi_set_mode(WIFI_MODE_STA);
        esp_wifi_set_config(WIFI_IF_STA, &sta);
        esp_wifi_start();

        display_draw_status(&u8g2, "Wi-Fi connecting...", NULL);

        EventBits_t bits = xEventGroupWaitBits(wifi_event_group,
                BIT0,
                pdFALSE,
                pdFALSE,
                pdMS_TO_TICKS(WIFI_CONNECT_TIMEOUT_MS)
        );

        if ((bits & BIT0) == 0) {
            // Connection failed; start SoftAP + portal
            portal_run_blocking(&u8g2);
        }

        if (!portal_skip_no_mqtt) {
            // Connected; start MQTT client
            display_draw_status(&u8g2, "Wi-Fi connected", NULL);
            mqtt_start(CONFIG_MQTT_BROKER_URI);
        }
    }

    if (portal_skip_no_mqtt) {
        display_draw_status(&u8g2, "Started without data export", NULL);
    }

    sensor_init();

    /* Main application loop 
        reads temperature and humidity data from sensor, displays it and publishes via MQTT
        cycle repeats every ~6 seconds
    */ 
    while (1) {
        float temp, hum;
        sensor_read(&temp, &hum);

        ESP_LOGI(TAG, "T=%.2fC H=%.2f%%", temp, hum);
        mqtt_publish_values(temp, hum, CONFIG_MQTT_TOPIC);

        // Display temperature
        u8g2_ClearBuffer(&u8g2);
        u8g2_SetFont(&u8g2, u8g2_font_ncenB14_tr);

        char line[16];
        snprintf(line, sizeof(line), "%.1f  C", temp);
        u8g2_DrawStr(&u8g2, 15, 38, line);

        // Circle serving as degree symbol
        u8g2_DrawCircle(&u8g2, 59, 25, 2, U8G2_DRAW_ALL);

        // Icon of a thermometer
        // Generated from free icon at https://javl.github.io/image2cpp/
        const uint8_t thermo_bitmap[] = {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x01, 
            0x00, 0x00, 0x00, 0x00, 0x18, 0x03, 0x00, 0x00, 0x00, 0x00, 0x58, 0x3a, 0x00, 0x00, 0x00, 0x00, 
            0x58, 0x7a, 0x00, 0x00, 0x00, 0x00, 0x58, 0x02, 0x00, 0x00, 0x00, 0x00, 0x58, 0x1a, 0x00, 0x00, 
            0x00, 0x00, 0x58, 0x02, 0x00, 0x00, 0x00, 0x00, 0x58, 0x02, 0x00, 0x00, 0x00, 0x00, 0x58, 0x7a, 
            0x00, 0x00, 0x00, 0x00, 0x58, 0x02, 0x00, 0x00, 0x00, 0x00, 0x58, 0x1e, 0x00, 0x00, 0x00, 0x00, 
            0x58, 0x02, 0x00, 0x00, 0x00, 0x00, 0x58, 0x02, 0x00, 0x00, 0x00, 0x00, 0x58, 0x3a, 0x00, 0x00, 
            0x00, 0x00, 0x58, 0x02, 0x00, 0x00, 0x00, 0x00, 0x58, 0x1a, 0x00, 0x00, 0x00, 0x00, 0x58, 0x02, 
            0x00, 0x00, 0x00, 0x00, 0x58, 0x02, 0x00, 0x00, 0x00, 0x00, 0x58, 0x7a, 0x00, 0x00, 0x00, 0x00, 
            0x48, 0x02, 0x00, 0x00, 0x00, 0x00, 0x4c, 0x06, 0x00, 0x00, 0x00, 0x00, 0xf4, 0x05, 0x00, 0x00, 
            0x00, 0x00, 0xf6, 0x09, 0x00, 0x00, 0x00, 0x00, 0xfa, 0x0b, 0x00, 0x00, 0x00, 0x00, 0xfa, 0x0b, 
            0x00, 0x00, 0x00, 0x00, 0xf4, 0x0d, 0x00, 0x00, 0x00, 0x00, 0x44, 0x04, 0x00, 0x00, 0x00, 0x00, 
            0x18, 0x03, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        };

        // Display bitmap thermometer
        u8g2_DrawXBM(&u8g2, 80, 8, 48, 48, thermo_bitmap);
        u8g2_SendBuffer(&u8g2);

        // Wait 3 seconds with progress bar
        display_progress_bar(&u8g2);

        u8g2_ClearBuffer(&u8g2);

        // Display humidity
        snprintf(line, sizeof(line), "%.1f %%", hum);
        u8g2_DrawStr(&u8g2, 15, 38, line);

        // Icon of a humidity
        // Generated from free icon at https://javl.github.io/image2cpp/
        const uint8_t humidity_bitmap[] = {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x03, 0x00, 0x00, 
            0x00, 0x00, 0x40, 0x02, 0x00, 0x00, 0x00, 0x00, 0x20, 0x04, 0x00, 0x00, 0x00, 0x00, 0x10, 0x08, 
            0x00, 0x00, 0x00, 0x00, 0x08, 0x10, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x30, 0x00, 0x00, 0x00, 0x00, 
            0x04, 0x60, 0x00, 0x00, 0x00, 0x00, 0x02, 0x40, 0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0x00, 0x00, 
            0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x01, 0x00, 0x00, 0xc0, 0x00, 0x00, 
            0x03, 0x00, 0x00, 0x40, 0x00, 0x00, 0x02, 0x00, 0x00, 0x60, 0x00, 0x00, 0x06, 0x00, 0x00, 0x20, 
            0x00, 0x00, 0x04, 0x00, 0x00, 0x20, 0x00, 0x00, 0x04, 0x00, 0x00, 0x10, 0x70, 0x04, 0x08, 0x00, 
            0x00, 0x10, 0x48, 0x04, 0x08, 0x00, 0x00, 0x10, 0x48, 0x02, 0x18, 0x00, 0x00, 0x18, 0x48, 0x02, 
            0x10, 0x00, 0x00, 0x08, 0x70, 0x01, 0x10, 0x00, 0x00, 0x08, 0x00, 0x1d, 0x10, 0x00, 0x00, 0x08, 
            0x80, 0x14, 0x10, 0x00, 0x00, 0x08, 0x80, 0x22, 0x10, 0x00, 0x00, 0x08, 0x40, 0x14, 0x10, 0x00, 
            0x00, 0x08, 0x40, 0x1c, 0x10, 0x00, 0x00, 0x18, 0x00, 0x00, 0x18, 0x00, 0x00, 0x10, 0x00, 0x00, 
            0x08, 0x00, 0x00, 0x30, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x20, 0x00, 0x00, 0x04, 0x00, 0x00, 0x40, 
            0x00, 0x00, 0x02, 0x00, 0x00, 0x80, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x00, 
            0x00, 0x00, 0x1e, 0x78, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        };

        // Display bitmap humidity
        u8g2_DrawXBM(&u8g2, 80, 8, 48, 48, humidity_bitmap);
        u8g2_SendBuffer(&u8g2);

        // Wait 3 seconds with progress bar
        display_progress_bar(&u8g2);
    }
}
